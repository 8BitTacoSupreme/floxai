#!/bin/bash
set -e

echo "ðŸŒŸ Starting FloxAI - The Complete Flox Development Co-pilot"
echo "============================================================"
echo "ðŸŽ¯ This showcases Flox's power for reproducible development environments!"
echo ""

# Check if we're in a Flox environment
if [ -z "$FLOX_ENV" ]; then
    echo "âŒ FloxAI must be run inside a Flox environment"
    echo "   This demonstrates Flox's environment isolation!"
    echo "   Run: flox activate"
    exit 1
fi

# Check if setup has been run
if [ ! -f "$FLOX_ENV_PROJECT/data/floxai.db" ]; then
    echo "âŒ FloxAI not initialized"
    echo "   Run: floxai-setup first"
    exit 1
fi

echo "ðŸ”§ Flox Environment: $FLOX_ENV_NAME"
echo "ðŸ“ Project Directory: $FLOX_ENV_PROJECT"
echo "ðŸ¤– Claude API: ${CLAUDE_API_KEY:0:20}..."
echo ""

# Start backend service
echo "ðŸš€ Starting FloxAI Backend Service..."
cd $FLOX_ENV_PROJECT/backend
export CLAUDE_API_KEY="$CLAUDE_API_KEY"
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload &
BACKEND_PID=$!

# Wait for backend to start
echo "   â³ Waiting for backend to initialize..."
sleep 8

# Check if backend is healthy
if curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo "   âœ… Backend service started successfully"
else
    echo "   âŒ Backend failed to start"
    echo "   ðŸ’¡ Check the logs above for errors"
    exit 1
fi

# Start frontend service
echo "ðŸŒ Starting FloxAI Frontend Service..."
cd $FLOX_ENV_PROJECT/frontend
npm run dev &
FRONTEND_PID=$!

# Wait for frontend to start
echo "   â³ Waiting for frontend to initialize..."
sleep 5

echo ""
echo "ðŸŽ‰ FloxAI is now running with Flox Services!"
echo "============================================="
echo "   ðŸŒ Frontend: http://localhost:3000"
echo "   ðŸ”§ Backend:  http://localhost:8000"
echo "   ðŸ“– API Docs: http://localhost:8000/docs"
echo "   â¤ï¸  Health:   http://localhost:8000/health"
echo ""
echo "ðŸŽ¯ Flox Services Active:"
echo "   âœ“ floxai-backend  - FastAPI with RAG & LLM"
echo "   âœ“ floxai-frontend - React development server"
echo ""
echo "ðŸ’¡ This demonstrates Flox's service orchestration capabilities!"
echo "   All services run within the Flox environment with proper isolation."
echo ""
echo "Press Ctrl+C to stop all services"

# Cleanup function
cleanup() {
    echo ""
    echo "ðŸ›‘ Stopping FloxAI services..."
    kill $BACKEND_PID $FRONTEND_PID 2>/dev/null || true
    sleep 2
    echo "ðŸ‘‹ FloxAI stopped - Flox environment remains active"
    exit 0
}

trap cleanup SIGINT SIGTERM
wait
