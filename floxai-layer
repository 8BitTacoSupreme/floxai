#!/bin/bash
set -e

echo "ðŸ” FloxAI Layer Mode - Environment Analysis"
echo "==========================================="

# Check if we're in a Flox environment
if [ -z "$FLOX_ENV" ]; then
    echo "âŒ FloxAI Layer must be used within a Flox environment"
    echo "   This demonstrates Flox's layer composition capabilities!"
    echo "   Run: flox activate"
    exit 1
fi

echo "ðŸŽ¯ Analyzing current Flox environment..."
echo "   Environment: $FLOX_ENV_NAME"
echo "   Project: $FLOX_ENV_PROJECT"
echo ""

# Detect project type and files
PROJECT_TYPE="unknown"
if [ -f "package.json" ]; then
    PROJECT_TYPE="nodejs"
elif [ -f "Cargo.toml" ]; then
    PROJECT_TYPE="rust"
elif [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
    PROJECT_TYPE="python"
elif [ -f "go.mod" ]; then
    PROJECT_TYPE="go"
fi

echo "ðŸ“Š Environment Analysis:"
echo "   Project Type: $PROJECT_TYPE"
echo "   Manifest: $([ -f "manifest.toml" ] && echo "âœ… Found" || echo "âŒ Not found")"
echo "   FloxAI Layer: âœ… Active"
echo ""

# Set environment variables for context-aware mode
export FLOXAI_CONTEXT_MODE=true
export FLOXAI_CURRENT_ENV="$FLOX_ENV_NAME"
export FLOXAI_PROJECT_TYPE="$PROJECT_TYPE"
export FLOXAI_LAYER_MODE=true

echo "ðŸš€ Starting FloxAI with environment context..."
echo "   Mode: Layer Analysis"
echo "   Context: $PROJECT_TYPE project in $FLOX_ENV_NAME"
echo ""

# Start backend with context
cd $FLOX_ENV_PROJECT/backend
export CLAUDE_API_KEY="$CLAUDE_API_KEY"
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload &
BACKEND_PID=$!

# Wait for backend to start
echo "   â³ Waiting for backend to initialize..."
sleep 8

# Check if backend is healthy
if curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo "   âœ… Backend service started successfully"
else
    echo "   âŒ Backend failed to start"
    echo "   ðŸ’¡ Check the logs above for errors"
    exit 1
fi

# Start frontend service
echo "ðŸŒ Starting FloxAI Frontend Service..."
cd $FLOX_ENV_PROJECT/frontend
npm run dev &
FRONTEND_PID=$!

# Wait for frontend to start
echo "   â³ Waiting for frontend to initialize..."
sleep 5

echo ""
echo "ðŸŽ‰ FloxAI Layer Mode Ready!"
echo "=========================="
echo "   ðŸŒ Frontend: http://localhost:3000"
echo "   ðŸ”§ Backend:  http://localhost:8000"
echo "   ðŸ“– API Docs: http://localhost:8000/docs"
echo ""
echo "ðŸŽ¯ Layer Features:"
echo "   âœ“ Environment Analysis: $PROJECT_TYPE project"
echo "   âœ“ Context-Aware Suggestions"
echo "   âœ“ Manifest Optimization"
echo "   âœ“ Flox Best Practices"
echo ""
echo "ðŸ’¡ This demonstrates Flox's layer composition!"
echo "   FloxAI is now analyzing your environment and can provide"
echo "   specific suggestions for your $PROJECT_TYPE project."
echo ""
echo "Press Ctrl+C to stop"

cleanup() {
    echo ""
    echo "ðŸ›‘ Stopping FloxAI Layer services..."
    kill $BACKEND_PID 2>/dev/null || true
    kill $FRONTEND_PID 2>/dev/null || true
    sleep 1
    echo "ðŸ‘‹ FloxAI Layer stopped - your Flox environment remains active"
    exit 0
}

trap cleanup SIGINT SIGTERM
wait
